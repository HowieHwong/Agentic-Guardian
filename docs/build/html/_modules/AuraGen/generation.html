

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AuraGen.generation &mdash; AuraGen 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=035a8b3d" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #2980B9" >

          
          
          <a href="../../index.html" class="icon icon-home">
            AuraGen
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scenarios.html">Scenarios</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../risk_injection.html">Risk Injection</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #2980B9" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AuraGen</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">AuraGen.generation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for AuraGen.generation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Harmless Data Generation Module</span>

<span class="sd">This module generates original, harmless agent action records using LLMs.</span>
<span class="sd">Supports both open-source (local) and API-based (OpenAI) models.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">validator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">AuraGen.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">GuardianConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">AuraGen.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">ScenarioContext</span><span class="p">,</span> <span class="n">Tool</span><span class="p">,</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">EnvironmentVariable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">AuraGen.inference</span><span class="w"> </span><span class="kn">import</span> <span class="n">InferenceManager</span><span class="p">,</span> <span class="n">OpenAIConfig</span><span class="p">,</span> <span class="n">externalAPIConfig</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="c1"># Optional: import transformers only if needed</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="kn">import</span> <span class="n">pipeline</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="ContextDiversifier">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.ContextDiversifier">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ContextDiversifier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility class to create diverse variations of scenario contexts.</span>
<span class="sd">    Enhances generation diversity by modifying tools, environment variables,</span>
<span class="sd">    and other context elements using LLM-based diversification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="ContextDiversifier.create_diverse_scenario">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.ContextDiversifier.create_diverse_scenario">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_diverse_scenario</span><span class="p">(</span><span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">llm_client</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Scenario</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a variation of the scenario with diversified context.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            scenario: Original scenario</span>
<span class="sd">            diversity_level: Level of diversification (0.0 to 1.0)</span>
<span class="sd">            llm_client: Optional LLM client for intelligent diversification</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            New scenario with diversified context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a deep copy to avoid modifying the original</span>
        <span class="n">diverse_scenario</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
        
        <span class="c1"># Skip if no context available</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">diverse_scenario</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">diverse_scenario</span>
            
        <span class="c1"># Apply diversification to the context</span>
        <span class="n">diverse_scenario</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_context</span><span class="p">(</span>
            <span class="n">diverse_scenario</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> 
            <span class="n">diversity_level</span><span class="p">,</span>
            <span class="n">llm_client</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">diverse_scenario</span></div>

    
<div class="viewcode-block" id="ContextDiversifier.diversify_context">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.ContextDiversifier.diversify_context">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diversify_context</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">ScenarioContext</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">llm_client</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScenarioContext</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Diversify a scenario context by modifying its components.&quot;&quot;&quot;</span>
        <span class="c1"># Diversify tools</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">:</span>
            <span class="c1"># Randomly remove some tools if diversity is high</span>
            <span class="k">if</span> <span class="n">diversity_level</span> <span class="o">&gt;</span> <span class="mf">0.7</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">keep_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">diversity_level</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">))))</span>
                <span class="n">context</span><span class="o">.</span><span class="n">available_tools</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">,</span> <span class="n">keep_count</span><span class="p">)</span>
            
            <span class="c1"># Shuffle tool order</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">)</span>
            
            <span class="c1"># Diversify individual tools</span>
            <span class="n">context</span><span class="o">.</span><span class="n">available_tools</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">available_tools</span>
            <span class="p">]</span>
        
        <span class="c1"># Diversify environment</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_environment</span><span class="p">(</span>
                <span class="n">context</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> 
                <span class="n">diversity_level</span><span class="p">,</span>
                <span class="n">llm_client</span>
            <span class="p">)</span>
        
        <span class="c1"># Diversify predefined variables</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">predefined_variables</span> <span class="ow">and</span> <span class="n">llm_client</span><span class="p">:</span>
            <span class="c1"># Intelligent diversification using LLM</span>
            <span class="n">context</span><span class="o">.</span><span class="n">predefined_variables</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_variables_with_llm</span><span class="p">(</span>
                <span class="n">context</span><span class="o">.</span><span class="n">predefined_variables</span><span class="p">,</span>
                <span class="n">diversity_level</span><span class="p">,</span>
                <span class="n">llm_client</span><span class="p">,</span>
                <span class="s2">&quot;predefined_variables&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">context</span><span class="o">.</span><span class="n">predefined_variables</span><span class="p">:</span>
            <span class="c1"># Fallback to basic shuffling if no LLM available</span>
            <span class="n">predefined_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">predefined_variables</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">predefined_vars</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">predefined_variables</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">predefined_vars</span><span class="p">)</span>
        
        <span class="c1"># Diversify system info and security policy (if present)</span>
        <span class="k">for</span> <span class="n">info_dict_name</span><span class="p">,</span> <span class="n">info_dict</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;system_info&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">system_info</span><span class="p">),</span> 
                                         <span class="p">(</span><span class="s2">&quot;security_policy&quot;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">security_policy</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">info_dict</span> <span class="ow">and</span> <span class="n">llm_client</span><span class="p">:</span>
                <span class="c1"># Use LLM to diversify these dictionaries</span>
                <span class="n">new_dict</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_variables_with_llm</span><span class="p">(</span>
                    <span class="n">info_dict</span><span class="p">,</span>
                    <span class="n">diversity_level</span><span class="p">,</span>
                    <span class="n">llm_client</span><span class="p">,</span>
                    <span class="n">info_dict_name</span>
                <span class="p">)</span>
                <span class="c1"># Update the original dictionary</span>
                <span class="n">info_dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">info_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_dict</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">info_dict</span><span class="p">:</span>
                <span class="c1"># Fallback to basic shuffling</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">info_dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
                <span class="n">info_dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">info_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">context</span></div>

    
<div class="viewcode-block" id="ContextDiversifier.diversify_tool">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.ContextDiversifier.diversify_tool">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diversify_tool</span><span class="p">(</span><span class="n">tool</span><span class="p">:</span> <span class="n">Tool</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">llm_client</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a diversified version of a tool.&quot;&quot;&quot;</span>
        <span class="c1"># Randomly reorder parameters</span>
        <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        
        <span class="c1"># Use LLM to diversify tool examples if available</span>
        <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span> <span class="ow">and</span> <span class="n">llm_client</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">diversity_level</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_examples_with_llm</span><span class="p">(</span>
                    <span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span><span class="p">,</span>
                    <span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">tool</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="n">diversity_level</span><span class="p">,</span>
                    <span class="n">llm_client</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to diversify tool examples with LLM: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Fallback to shuffle</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span><span class="p">:</span>
            <span class="c1"># Fallback to shuffle</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span><span class="p">)</span>
            
            <span class="c1"># Limit examples to a random subset if there are many</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">diversity_level</span><span class="p">:</span>
                <span class="n">keep_count</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">diversity_level</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)))</span>
                <span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">example_usage</span><span class="p">[:</span><span class="n">keep_count</span><span class="p">]</span>
                
        <span class="c1"># Randomly reorder common errors</span>
        <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">common_errors</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tool</span><span class="o">.</span><span class="n">common_errors</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">tool</span></div>

    
<div class="viewcode-block" id="ContextDiversifier.diversify_environment">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.ContextDiversifier.diversify_environment">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diversify_environment</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">llm_client</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Environment</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a diversified version of an environment.&quot;&quot;&quot;</span>
        <span class="c1"># Shuffle environment variables</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
            
            <span class="c1"># Diversify non-sensitive variables</span>
            <span class="n">env</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_env_variable</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">sensitive</span> <span class="k">else</span> <span class="n">var</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">variables</span>
            <span class="p">]</span>
        
        <span class="c1"># Shuffle allowed and blocked domains</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">allowed_domains</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">allowed_domains</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">blocked_domains</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">blocked_domains</span><span class="p">)</span>
            
        <span class="c1"># Slightly modify resource limits if they exist</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">max_memory_mb</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">diversity_level</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">max_memory_mb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">max_memory_mb</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">max_execution_time</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">diversity_level</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">max_execution_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">max_execution_time</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">max_file_size_mb</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">diversity_level</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">max_file_size_mb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">max_file_size_mb</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.9</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">))</span>
        
        <span class="c1"># Diversify settings with LLM if available</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">settings</span> <span class="ow">and</span> <span class="n">llm_client</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_variables_with_llm</span><span class="p">(</span>
                <span class="n">env</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
                <span class="n">diversity_level</span><span class="p">,</span>
                <span class="n">llm_client</span><span class="p">,</span>
                <span class="s2">&quot;environment_settings&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">env</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
            <span class="c1"># Fallback to shuffle</span>
            <span class="n">settings_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">settings_items</span><span class="p">)</span>
            <span class="n">env</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">settings_items</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">env</span></div>

    
<div class="viewcode-block" id="ContextDiversifier.diversify_env_variable">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.ContextDiversifier.diversify_env_variable">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diversify_env_variable</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="n">EnvironmentVariable</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">llm_client</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EnvironmentVariable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a diversified version of an environment variable.&quot;&quot;&quot;</span>
        <span class="c1"># Don&#39;t modify sensitive variables</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">sensitive</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">var</span>
            
        <span class="c1"># For non-sensitive variables, use LLM if available</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">llm_client</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">diversity_level</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">var</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_value_with_llm</span><span class="p">(</span>
                    <span class="n">var</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">var</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;Environment variable </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">diversity_level</span><span class="p">,</span>
                    <span class="n">llm_client</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to diversify env variable with LLM: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">diversity_level</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="c1"># Slightly modify numeric values</span>
            <span class="n">modifier</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">diversity_level</span>
            <span class="n">var</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">modifier</span>
            
        <span class="k">return</span> <span class="n">var</span></div>


<div class="viewcode-block" id="ContextDiversifier.diversify_value_with_llm">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.ContextDiversifier.diversify_value_with_llm">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diversify_value_with_llm</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use LLM to create a semantically similar but different value.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            value: Original string value</span>
<span class="sd">            name: Name/key of the variable</span>
<span class="sd">            description: Description of what the value represents</span>
<span class="sd">            diversity_level: Level of diversification (0.0 to 1.0)</span>
<span class="sd">            llm_client: LLM client or InferenceManager to use for diversification</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Diversified string value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Skip diversification for very short values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
            
        <span class="c1"># Determine diversification level in prompt</span>
        <span class="k">if</span> <span class="n">diversity_level</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">diversity_desc</span> <span class="o">=</span> <span class="s2">&quot;slightly different but semantically equivalent&quot;</span>
        <span class="k">elif</span> <span class="n">diversity_level</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="n">diversity_desc</span> <span class="o">=</span> <span class="s2">&quot;moderately different while maintaining the same meaning&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diversity_desc</span> <span class="o">=</span> <span class="s2">&quot;significantly different but serving the same purpose&quot;</span>
        
        <span class="c1"># Construct prompt</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are helping to create diverse variants of configuration values.</span>
<span class="s2">Given the following value for &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">), create a </span><span class="si">{</span><span class="n">diversity_desc</span><span class="si">}</span><span class="s2"> alternative.</span>
<span class="s2">The value must maintain the same general format and purpose, but should be visibly different.</span>
<span class="s2">Do not include any explanation, only return the new value.</span>

<span class="s2">Original value: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span>

<span class="s2">New value:&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">llm_client</span><span class="p">,</span> <span class="s1">&#39;generate_text&#39;</span><span class="p">):</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">llm_client</span><span class="o">.</span><span class="n">generate_text</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">completion</span> <span class="o">=</span> <span class="n">llm_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">llm_client</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">max_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
            <span class="p">)</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
            
            <span class="c1"># Clean the new value</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="c1"># Safety check - don&#39;t return empty value or something too different in length</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_value</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
                
            <span class="k">return</span> <span class="n">new_value</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM diversification error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="ContextDiversifier.diversify_examples_with_llm">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.ContextDiversifier.diversify_examples_with_llm">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diversify_examples_with_llm</span><span class="p">(</span><span class="n">examples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">tool_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                   <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">llm_client</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use LLM to create diverse variants of tool examples.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            examples: Original list of example strings</span>
<span class="sd">            tool_name: Name of the tool</span>
<span class="sd">            tool_description: Description of the tool</span>
<span class="sd">            diversity_level: Level of diversification (0.0 to 1.0)</span>
<span class="sd">            llm_client: LLM client or InferenceManager to use for diversification</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of diversified examples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">examples</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">examples</span>
            
        <span class="c1"># Limit the number of examples to process to control API usage</span>
        <span class="n">max_examples</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">examples</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">selected_examples</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">examples</span><span class="p">,</span> <span class="n">max_examples</span><span class="p">)</span>
        <span class="n">other_examples</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex</span> <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">examples</span> <span class="k">if</span> <span class="n">ex</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selected_examples</span><span class="p">]</span>
        
        <span class="c1"># Determine diversification level in prompt</span>
        <span class="k">if</span> <span class="n">diversity_level</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">diversity_desc</span> <span class="o">=</span> <span class="s2">&quot;slightly different but functionally equivalent&quot;</span>
        <span class="k">elif</span> <span class="n">diversity_level</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="n">diversity_desc</span> <span class="o">=</span> <span class="s2">&quot;moderately different while maintaining the same functionality&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diversity_desc</span> <span class="o">=</span> <span class="s2">&quot;significantly different but serving the same purpose&quot;</span>
        
        <span class="c1"># Construct prompt</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;You are helping to create diverse variants of tool usage examples.</span>
<span class="s2">Given the following examples for the tool &quot;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">tool_description</span><span class="si">}</span><span class="s2">), </span>
<span class="s2">create </span><span class="si">{</span><span class="n">diversity_desc</span><span class="si">}</span><span class="s2"> alternatives for each example.</span>
<span class="s2">The examples must maintain the same general format and functionality, but should be visibly different.</span>
<span class="s2">Do not include any explanation, return only the new examples, one per line.</span>

<span class="s2">Original examples:</span>
<span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">selected_examples</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">New examples:&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">llm_client</span><span class="p">,</span> <span class="s1">&#39;generate_text&#39;</span><span class="p">):</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">llm_client</span><span class="o">.</span><span class="n">generate_text</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">completion</span> <span class="o">=</span> <span class="n">llm_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">llm_client</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">max_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
            <span class="p">)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
            
            <span class="c1"># Extract and clean the new examples</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">new_examples</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
            
            <span class="c1"># Safety check - ensure we have at least some examples</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_examples</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">examples</span>
                
            <span class="c1"># Combine with non-modified examples to maintain diversity</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">new_examples</span> <span class="o">+</span> <span class="n">other_examples</span>
            
            <span class="c1"># Shuffle the final result</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM examples diversification error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">examples</span></div>


<div class="viewcode-block" id="ContextDiversifier.diversify_variables_with_llm">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.ContextDiversifier.diversify_variables_with_llm">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">diversify_variables_with_llm</span><span class="p">(</span><span class="n">variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                                    <span class="n">llm_client</span><span class="p">,</span> <span class="n">context_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use LLM to create semantically diverse variations of variable values.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            variables: Dictionary of variables to diversify</span>
<span class="sd">            diversity_level: Level of diversification (0.0 to 1.0)</span>
<span class="sd">            llm_client: LLM client to use for diversification</span>
<span class="sd">            context_name: Name of the context (for prompt)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with diversified values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">variables</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">variables</span>
            
        <span class="c1"># Create a copy to modify</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">variables</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Identify text values that can be safely modified</span>
        <span class="n">text_variables</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> 
                         <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">sensitive</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">sensitive</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">,</span> <span class="s1">&#39;api&#39;</span><span class="p">])}</span>
        
        <span class="c1"># Skip if no text variables to modify</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text_variables</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
            
        <span class="c1"># Only process a subset of variables to control API usage</span>
        <span class="n">max_vars</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">text_variables</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">selected_vars</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">text_variables</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">max_vars</span><span class="p">)</span>
        
        <span class="c1"># Process each selected variable</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">selected_vars</span><span class="p">:</span>
            <span class="c1"># Skip very short values</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="c1"># Only diversify with a probability based on diversity level</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">diversity_level</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">diversify_value_with_llm</span><span class="p">(</span>
                        <span class="n">value</span><span class="p">,</span> 
                        <span class="n">key</span><span class="p">,</span> 
                        <span class="sa">f</span><span class="s2">&quot;Variable in </span><span class="si">{</span><span class="n">context_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                        <span class="n">diversity_level</span><span class="p">,</span>
                        <span class="n">llm_client</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to diversify variable with LLM: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
</div>



<div class="viewcode-block" id="MetadataDefinition">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.MetadataDefinition">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MetadataDefinition</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Definition of how a metadata attribute should be interpreted.&quot;&quot;&quot;</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;^(categorical|range)$&quot;</span><span class="p">)</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="MetadataConfig">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.MetadataConfig">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MetadataConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for metadata handling.&quot;&quot;&quot;</span>
    <span class="n">generation_attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MetadataDefinition</span><span class="p">]</span>

<div class="viewcode-block" id="MetadataConfig.get_constraint_for_attribute">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.MetadataConfig.get_constraint_for_attribute">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_constraint_for_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a constraint string for a given metadata attribute and value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generation_attributes</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generation_attributes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span>
        
        <span class="c1"># For range type, validate against allowed values</span>
        <span class="k">if</span> <span class="n">definition</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;range&quot;</span> <span class="ow">and</span> <span class="n">definition</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">definition</span><span class="o">.</span><span class="n">values</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> not in allowed values for </span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">definition</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">definition</span><span class="o">.</span><span class="n">prompt_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error formatting constraint for </span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="AgentActionRecord">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.AgentActionRecord">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AgentActionRecord</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Data model for a single agent action record.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Scenario name from config&quot;</span><span class="p">)</span>
    <span class="n">user_request</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;User&#39;s request or input&quot;</span><span class="p">)</span>
    <span class="n">agent_action</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Agent&#39;s action plan as a list of steps&quot;</span><span class="p">)</span>
    <span class="n">agent_response</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Agent&#39;s response to the user&quot;</span><span class="p">)</span>
    
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
            <span class="s2">&quot;constraints&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;scenario_metadata&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;generation_settings&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">},</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Additional metadata including generation timestamp, constraints, and settings&quot;</span>
    <span class="p">)</span>

<div class="viewcode-block" id="AgentActionRecord.Config">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.AgentActionRecord.Config">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">Config</span><span class="p">:</span>
        <span class="n">json_encoders</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">datetime</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="HarmlessDataGeneratorBase">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.HarmlessDataGeneratorBase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HarmlessDataGeneratorBase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for harmless data generators.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="HarmlessDataGeneratorBase.__init__">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.HarmlessDataGeneratorBase.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">GuardianConfig</span><span class="p">,</span> <span class="n">metadata_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetadataConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span> <span class="o">=</span> <span class="n">metadata_config</span></div>


<div class="viewcode-block" id="HarmlessDataGeneratorBase.generate_record">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.HarmlessDataGeneratorBase.generate_record">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentActionRecord</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a single agent action record for a given scenario.</span>
<span class="sd">        Must be implemented by subclasses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="HarmlessDataGeneratorBase.generate_batch">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.HarmlessDataGeneratorBase.generate_batch">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">diversity_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentActionRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a batch of agent action records for a given scenario.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            scenario: Scenario to generate records for</span>
<span class="sd">            n: Number of records to generate</span>
<span class="sd">            diversity_range: Range of diversity levels to use (min, max)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of generated records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_diversity</span><span class="p">,</span> <span class="n">max_diversity</span> <span class="o">=</span> <span class="n">diversity_range</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1"># Generate a random diversity level for each record</span>
            <span class="n">diversity_level</span> <span class="o">=</span> <span class="n">min_diversity</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_diversity</span> <span class="o">-</span> <span class="n">min_diversity</span><span class="p">)</span>
            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_record</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">))</span>
            
        <span class="k">return</span> <span class="n">records</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_metadata_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a constraint string from scenario metadata to guide generation.</span>
<span class="sd">        Returns both the prompt constraint and the list of applied constraints for record keeping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[]</span>

        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">applied_constraints</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">scenario</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">attr_def</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span><span class="o">.</span><span class="n">generation_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">attr_def</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">attr_def</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">constraint</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span><span class="o">.</span><span class="n">get_constraint_for_attribute</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                        <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                        <span class="n">applied_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;attribute&quot;</span><span class="p">:</span> <span class="n">attr_name</span><span class="p">,</span>
                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                            <span class="s2">&quot;constraint&quot;</span><span class="p">:</span> <span class="n">constraint</span><span class="p">,</span>
                            <span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="n">attr_def</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
                        <span class="p">})</span>
            <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constraints</span><span class="p">),</span> <span class="n">applied_constraints</span>

        <span class="k">if</span> <span class="s2">&quot;selection_way&quot;</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> <span class="n">scenario</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;selection_way&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span>
            <span class="n">selection_num</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selection_num&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  
            <span class="n">available_attrs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span><span class="o">.</span><span class="n">generation_attributes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">selection_num</span><span class="p">:</span>
                <span class="n">selected_attrs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">available_attrs</span><span class="p">,</span> <span class="n">selection_num</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_attrs</span> <span class="o">=</span> <span class="n">available_attrs</span>
                
            <span class="k">for</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">selected_attrs</span><span class="p">:</span>
                <span class="n">attr_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span><span class="o">.</span><span class="n">generation_attributes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">attr_def</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">attr_def</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">constraint</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span><span class="o">.</span><span class="n">get_constraint_for_attribute</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                        <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                        <span class="n">applied_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                            <span class="s2">&quot;attribute&quot;</span><span class="p">:</span> <span class="n">attr_name</span><span class="p">,</span>
                            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                            <span class="s2">&quot;constraint&quot;</span><span class="p">:</span> <span class="n">constraint</span><span class="p">,</span>
                            <span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="n">attr_def</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
                        <span class="p">})</span>
            <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constraints</span><span class="p">),</span> <span class="n">applied_constraints</span>

        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;selection_way&quot;</span><span class="p">,</span> <span class="s2">&quot;selection_num&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
                
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">values</span>

            <span class="k">if</span> <span class="n">constraint</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span><span class="o">.</span><span class="n">get_constraint_for_attribute</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
                <span class="n">applied_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;attribute&quot;</span><span class="p">:</span> <span class="n">attr_name</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;constraint&quot;</span><span class="p">:</span> <span class="n">constraint</span><span class="p">,</span>
                    <span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span><span class="o">.</span><span class="n">generation_attributes</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
                <span class="p">})</span>

        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">constraints</span><span class="p">),</span> <span class="n">applied_constraints</span></div>



<div class="viewcode-block" id="OpenAIHarmlessDataGenerator">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.OpenAIHarmlessDataGenerator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpenAIHarmlessDataGenerator</span><span class="p">(</span><span class="n">HarmlessDataGeneratorBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Harmless data generator using OpenAI API with enhanced tool and environment support.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="OpenAIHarmlessDataGenerator.__init__">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.OpenAIHarmlessDataGenerator.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">GuardianConfig</span><span class="p">,</span> <span class="n">openai_config</span><span class="p">:</span> <span class="n">OpenAIConfig</span><span class="p">,</span> <span class="n">metadata_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetadataConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">externalAPI_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">externalAPIConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">use_internal_inference</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize OpenAI-based harmless data generator.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            config: Guardian configuration</span>
<span class="sd">            openai_config: OpenAI API configuration</span>
<span class="sd">            metadata_config: Optional metadata configuration</span>
<span class="sd">            externalAPI_config: Optional externalAPI API configuration (for internal inference)</span>
<span class="sd">            use_internal_inference: Whether to use internal inference</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">metadata_config</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">openai_config</span> <span class="o">=</span> <span class="n">openai_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">externalAPI_config</span> <span class="o">=</span> <span class="n">externalAPI_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_internal_inference</span> <span class="o">=</span> <span class="n">use_internal_inference</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_manager</span> <span class="o">=</span> <span class="n">InferenceManager</span><span class="p">(</span>
            <span class="n">use_internal_inference</span><span class="o">=</span><span class="n">use_internal_inference</span><span class="p">,</span>
            <span class="n">openai_config</span><span class="o">=</span><span class="n">openai_config</span><span class="p">,</span>
            <span class="n">externalAPI_config</span><span class="o">=</span><span class="n">externalAPI_config</span>
        <span class="p">)</span>
            
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized OpenAIHarmlessDataGenerator with model: </span><span class="si">{</span><span class="n">openai_config</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_build_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a prompt for the LLM based on scenario information, tools, and environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata_constraint</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_constraint</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
        
        <span class="c1"># ----- SYSTEM PROMPT -----</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;You are an AI assistant tasked with generating realistic examples of user-agent interactions. &quot;</span>
            <span class="s2">&quot;Your goal is to create a coherent sequence consisting of: (1) a user request, (2) the agent&#39;s internal action plan, &quot;</span>
            <span class="s2">&quot;and (3) the agent&#39;s response to the user.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;The examples you generate should be varied, realistic, and follow all the requirements specified below. &quot;</span>
            <span class="s2">&quot;Pay special attention to the context requirements and ensure they are reflected throughout the interaction.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        
        <span class="c1"># ----- SCENARIO DEFINITION -----</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;# SCENARIO: </span><span class="si">{</span><span class="n">scenario</span><span class="o">.</span><span class="n">display_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scenario</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        
        <span class="c1"># ----- METADATA CONSTRAINTS -----</span>
        <span class="k">if</span> <span class="n">metadata_constraint</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;# CONTEXT REQUIREMENTS</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metadata_constraint</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;These requirements must be reflected in the user request and throughout the entire interaction.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># ----- TOOLS &amp; ENVIRONMENT -----</span>
        <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="c1"># Add tool context</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">:</span>
                <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;# AVAILABLE TOOLS</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">prompt</span> <span class="o">+=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_generation_context</span><span class="p">()</span>
                <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            
            <span class="c1"># Add environment context</span>
            <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
                <span class="n">env</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">environment</span>
                <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;# ENVIRONMENT: </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="c1"># Variables section</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;## Environment Variables</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">sensitive</span><span class="p">:</span>
                            <span class="n">value_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">type_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">type</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">desc_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">description</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">type_str</span><span class="si">}{</span><span class="n">desc_str</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="c1"># Add predefined variables</span>
                <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">predefined_variables</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;## Predefined Variables</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">predefined_variables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="c1"># Settings section</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">settings</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;## Environment Settings</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="c1"># Resource limits section</span>
                <span class="n">resource_limits</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;Memory&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">max_memory_mb</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">max_memory_mb</span><span class="si">}</span><span class="s2">MB&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Execution Time&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">max_execution_time</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">max_execution_time</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;File Size&quot;</span><span class="p">:</span> <span class="n">env</span><span class="o">.</span><span class="n">max_file_size_mb</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">max_file_size_mb</span><span class="si">}</span><span class="s2">MB&quot;</span>
                <span class="p">}</span>
                <span class="n">limits</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">resource_limits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">limits</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;## Resource Limits</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
                        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                
                <span class="c1"># Network access section</span>
                <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;## Network Access</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">network_access</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;Network access is **enabled** with the following rules:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">allowed_domains</span><span class="p">:</span>
                        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- Allowed domains: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">allowed_domains</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">blocked_domains</span><span class="p">:</span>
                        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- Blocked domains: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">blocked_domains</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;Network access is **disabled**.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        
                <span class="c1"># Security policy</span>
                <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">security_policy</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;## Security Policy</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">security_policy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># ----- GUIDELINES -----</span>
        <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;# GUIDELINES FOR TOOL USAGE</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;1. Use the provided tools appropriately in your action steps</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;2. Follow the parameter requirements and types for each tool</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;3. Incorporate the environment constraints and variables in your logic</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;4. Make realistic tool calls with proper parameter values</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;5. Consider potential error cases and handle them gracefully</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        
        <span class="c1"># ----- OUTPUT FORMAT -----</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;# OUTPUT FORMAT</span>
<span class="s2">Format your response exactly as follows:</span>

<span class="s2">User Request: &lt;user&#39;s request&gt;</span>
<span class="s2">Agent Action: &lt;numbered list of action steps&gt;</span>
<span class="s2">Agent Response: &lt;agent&#39;s reply to the user&gt;</span>

<span class="s2">## EXAMPLE</span>
<span class="s2">User Request: Please send a quarterly financial report to the executive team with all confidential data encrypted.</span>
<span class="s2">Agent Action: 1. search_contacts(query=&#39;executive team&#39;, search_type=&#39;name&#39;)</span>
<span class="s2">2. create_report(type=&#39;financial&#39;, period=&#39;quarterly&#39;, include_confidential=true)</span>
<span class="s2">3. encrypt_data(data_type=&#39;confidential&#39;, encryption_level=&#39;high&#39;)</span>
<span class="s2">4. send_email(recipients=[&#39;executives@company.com&#39;], subject=&#39;Quarterly Financial Report&#39;, body=&#39;Please find attached the quarterly financial report with encrypted confidential data.&#39;, attachments=[&#39;quarterly_report.pdf&#39;])</span>
<span class="s2">Agent Response: I&#39;ve compiled the quarterly financial report with all confidential data properly encrypted and sent it to the executive team. The report should be in their inboxes now. Would you like me to send you a confirmation when they&#39;ve received it?</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">prompt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_tool_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">action_step</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate if an action step uses available tools correctly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># No tools defined, any action is valid</span>
            
        <span class="c1"># Check if step uses any available tool</span>
        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">action_step</span><span class="p">:</span>
                <span class="c1"># Basic tool name match found</span>
                <span class="c1"># You could add more sophisticated validation here</span>
                <span class="k">return</span> <span class="kc">True</span>
                
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Step doesn&#39;t use tools, which is also valid</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_environment_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">action_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate and potentially modify action steps based on environment constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">action_steps</span>
            
        <span class="n">env</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">environment</span>
        <span class="n">validated_steps</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">action_steps</span><span class="p">:</span>
            <span class="c1"># Check for network access</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">env</span><span class="o">.</span><span class="n">network_access</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;download&quot;</span><span class="p">,</span> <span class="s2">&quot;network&quot;</span><span class="p">]):</span>
                <span class="c1"># Replace network actions with offline alternatives or skip</span>
                <span class="k">continue</span>
                
            <span class="c1"># Check file operations against size limits</span>
            <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">max_file_size_mb</span> <span class="ow">and</span> <span class="s2">&quot;file&quot;</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">step</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2"> # Ensure file size is under </span><span class="si">{</span><span class="n">env</span><span class="o">.</span><span class="n">max_file_size_mb</span><span class="si">}</span><span class="s2">MB&quot;</span>
                
            <span class="n">validated_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">validated_steps</span>

<div class="viewcode-block" id="OpenAIHarmlessDataGenerator.generate_record">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.OpenAIHarmlessDataGenerator.generate_record">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentActionRecord</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a single agent action record with enhanced tool and environment awareness.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            scenario: The scenario to generate an action record for</span>
<span class="sd">            diversity_level: Level of diversity for context elements (0.0 to 1.0)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            A generated agent action record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a diverse variant of the scenario if diversity_level &gt; 0</span>
        <span class="k">if</span> <span class="n">diversity_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scenario</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">create_diverse_scenario</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">)</span>
        
        <span class="c1"># Build the prompt for the given scenario</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_prompt</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
        
        <span class="c1"># Get metadata constraint</span>
        <span class="n">constraint_text</span><span class="p">,</span> <span class="n">metadata_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_constraint</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">constraint_text</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">constraint_text</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Add random sampling to prevent model from memorizing responses</span>
        <span class="n">prompt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Example ID: </span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">9999</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">9999</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="n">retry_count</span> <span class="o">&lt;</span> <span class="n">max_retries</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># print(prompt)</span>
                <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_manager</span><span class="o">.</span><span class="n">generate_text</span><span class="p">(</span>
                    <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
                    <span class="n">system_message</span><span class="o">=</span><span class="s2">&quot;You are an AI agent assistant that responds to user requests.&quot;</span>
                <span class="p">)</span>
        
                <span class="c1"># Parse the output into user request, action steps, and response</span>
                <span class="n">user_request</span><span class="p">,</span> <span class="n">action_steps</span><span class="p">,</span> <span class="n">agent_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_output</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        
                <span class="c1"># Validate that action steps are compatible with tools</span>
                <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">available_tools</span><span class="p">:</span>
                    <span class="c1"># Validate that each action step properly uses the available tools</span>
                    <span class="n">valid_steps</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">action_steps</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_tool_usage</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                            <span class="n">valid_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Replace invalid steps with default step</span>
                            <span class="n">valid_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;I&#39;ll analyze the request: &#39;</span><span class="si">{</span><span class="n">user_request</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    
                    <span class="n">action_steps</span> <span class="o">=</span> <span class="n">valid_steps</span>
                
                <span class="c1"># Validate environment constraints</span>
                <span class="k">if</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="n">scenario</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
                    <span class="n">action_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_environment_constraints</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">action_steps</span><span class="p">)</span>
        
                <span class="c1"># Create and return the record</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">AgentActionRecord</span><span class="p">(</span>
                    <span class="n">scenario_name</span><span class="o">=</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">user_request</span><span class="o">=</span><span class="n">user_request</span><span class="p">,</span>
                    <span class="n">agent_action</span><span class="o">=</span><span class="n">action_steps</span><span class="p">,</span>
                    <span class="n">agent_response</span><span class="o">=</span><span class="n">agent_response</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
                        <span class="s2">&quot;constraints&quot;</span><span class="p">:</span> <span class="n">metadata_values</span><span class="p">,</span>
                        <span class="s2">&quot;scenario_metadata&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">openai_config</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">openai_config</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">openai_config</span><span class="o">.</span><span class="n">max_tokens</span>
            <span class="p">},</span>
            <span class="s2">&quot;generation_settings&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;diversity_level&quot;</span><span class="p">:</span> <span class="n">diversity_level</span>
            <span class="p">}</span>
        <span class="p">}</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">metadata_values</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">metadata_values</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;attribute&quot;</span> <span class="ow">in</span> <span class="n">constraint</span> <span class="ow">and</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
                            <span class="n">record</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;scenario_metadata&quot;</span><span class="p">][</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;attribute&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                
                <span class="k">return</span> <span class="n">record</span>
                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating record, retrying (</span><span class="si">{</span><span class="n">retry_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate record after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="OpenAIHarmlessDataGenerator.generate_batch_concurrent">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.OpenAIHarmlessDataGenerator.generate_batch_concurrent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_batch_concurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">diversity_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentActionRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a batch of agent action records concurrently for a given scenario.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            scenario: Scenario to generate records for</span>
<span class="sd">            n: Number of records to generate</span>
<span class="sd">            max_workers: Maximum number of concurrent workers</span>
<span class="sd">            diversity_range: Range of diversity levels to use (min, max)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of generated records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_diversity</span><span class="p">,</span> <span class="n">max_diversity</span> <span class="o">=</span> <span class="n">diversity_range</span>
        
        <span class="c1"># Create tasks with varying diversity levels</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">diversity_level</span> <span class="o">=</span> <span class="n">min_diversity</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_diversity</span> <span class="o">-</span> <span class="n">min_diversity</span><span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">scenario</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">))</span>
        
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_record</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generating records for </span><span class="si">{</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">record</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during concurrent generation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">records</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the LLM output into user_request, agent_action, agent_response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_request</span> <span class="o">=</span> <span class="n">agent_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">agent_action</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">current_section</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">inside_code_block</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">code_block_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;```&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;/*&quot;</span><span class="p">,</span> <span class="s2">&quot;*/&quot;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">code_block_markers</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;```&quot;</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">:</span>
                <span class="n">inside_code_block</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">inside_code_block</span>
                <span class="k">continue</span>
                
            <span class="c1"># Skip processing lines inside code blocks for agent_action section</span>
            <span class="k">if</span> <span class="n">inside_code_block</span> <span class="ow">and</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s2">&quot;agent_action&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;user request:&quot;</span><span class="p">):</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="s2">&quot;user_request&quot;</span>
                <span class="n">user_request</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;agent action:&quot;</span><span class="p">):</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="s2">&quot;agent_action&quot;</span>
                <span class="c1"># First line might contain the first step</span>
                <span class="n">action_part</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">action_part</span><span class="p">:</span>
                    <span class="c1"># Remove numbering and add to list</span>
                    <span class="n">cleaned_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_step</span><span class="p">(</span><span class="n">action_part</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cleaned_step</span><span class="p">:</span>
                        <span class="n">agent_action</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned_step</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;agent response:&quot;</span><span class="p">):</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="s2">&quot;agent_response&quot;</span>
                <span class="n">agent_response</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s2">&quot;agent_action&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inside_code_block</span><span class="p">:</span>
                <span class="c1"># Additional action steps</span>
                <span class="n">cleaned_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_step</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cleaned_step</span><span class="p">:</span>
                    <span class="n">agent_action</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned_step</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s2">&quot;agent_response&quot;</span> <span class="ow">and</span> <span class="n">agent_response</span><span class="p">:</span>
                <span class="c1"># Multi-line response</span>
                <span class="n">agent_response</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">line</span>
                
        <span class="c1"># Filter out any empty entries from agent_action</span>
        <span class="n">agent_action</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">agent_action</span> <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                
        <span class="k">return</span> <span class="n">user_request</span><span class="p">,</span> <span class="n">agent_action</span><span class="p">,</span> <span class="n">agent_response</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean a step by removing numbering and extra whitespace.</span>
<span class="sd">        Filter out markdown code block markers and other non-action content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="c1"># Skip markdown code block markers and their language specifiers</span>
        <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;```&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># Skip other common non-action content</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Example:&quot;</span><span class="p">,</span> <span class="s2">&quot;Note:&quot;</span><span class="p">,</span> <span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="s2">&quot;Input:&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            
        <span class="c1"># Remove numbering patterns like &quot;1.&quot;, &quot;2)&quot;, &quot;- &quot;, etc.</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*(\d+[\.\)]\s*|-\s*|\*\s*)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>



<div class="viewcode-block" id="LocalHarmlessDataGenerator">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.LocalHarmlessDataGenerator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LocalHarmlessDataGenerator</span><span class="p">(</span><span class="n">HarmlessDataGeneratorBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Harmless data generator using a local open-source LLM (e.g., HuggingFace Transformers).</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LocalHarmlessDataGenerator.__init__">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.LocalHarmlessDataGenerator.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">GuardianConfig</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt2&quot;</span><span class="p">,</span> <span class="n">metadata_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetadataConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">llm_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;transformers package is required for LocalHarmlessDataGenerator.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generator</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="s2">&quot;text-generation&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_config</span> <span class="o">=</span> <span class="n">metadata_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="n">llm_client</span>  <span class="c1"># Optional external LLM client for diversification</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized LocalHarmlessDataGenerator with model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_build_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Scenario: </span><span class="si">{</span><span class="n">scenario</span><span class="o">.</span><span class="n">display_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Description: </span><span class="si">{</span><span class="n">scenario</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Generate a user request, agent action (as numbered steps), and agent response.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;User Request:&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">prompt</span>

<div class="viewcode-block" id="LocalHarmlessDataGenerator.generate_record">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.LocalHarmlessDataGenerator.generate_record">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AgentActionRecord</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a single agent action record with diverse context elements.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            scenario: The scenario to generate an action record for</span>
<span class="sd">            diversity_level: Level of diversity for context elements (0.0 to 1.0)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            A generated agent action record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply diversity to the scenario if LLM client is available</span>
        <span class="k">if</span> <span class="n">diversity_level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">:</span>
            <span class="n">diverse_scenario</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">create_diverse_scenario</span><span class="p">(</span>
                <span class="n">scenario</span><span class="p">,</span> 
                <span class="n">diversity_level</span><span class="p">,</span>
                <span class="n">llm_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">diversity_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Fallback to basic diversification without LLM</span>
            <span class="n">diverse_scenario</span> <span class="o">=</span> <span class="n">ContextDiversifier</span><span class="o">.</span><span class="n">create_diverse_scenario</span><span class="p">(</span>
                <span class="n">scenario</span><span class="p">,</span> 
                <span class="n">diversity_level</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diverse_scenario</span> <span class="o">=</span> <span class="n">scenario</span>
        
        <span class="c1"># Get constraints and their details</span>
        <span class="n">prompt_constraint</span><span class="p">,</span> <span class="n">applied_constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_metadata_constraint</span><span class="p">(</span><span class="n">diverse_scenario</span><span class="p">)</span>
        
        <span class="n">selected_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;selection_way&quot;</span><span class="p">:</span> <span class="n">diverse_scenario</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selection_way&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">diverse_scenario</span><span class="o">.</span><span class="n">metadata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;selection_num&quot;</span><span class="p">:</span> <span class="n">diverse_scenario</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selection_num&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">diverse_scenario</span><span class="o">.</span><span class="n">metadata</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">applied_constraints</span><span class="p">:</span>
            <span class="n">selected_metadata</span><span class="p">[</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;attribute&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            
        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_prompt</span><span class="p">(</span><span class="n">diverse_scenario</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generator</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_return_sequences</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;generated_text&quot;</span><span class="p">]</span>
        
        <span class="c1"># Parse the output into fields</span>
        <span class="n">user_request</span><span class="p">,</span> <span class="n">agent_action</span><span class="p">,</span> <span class="n">agent_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_output</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                    
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
            <span class="s2">&quot;constraints&quot;</span><span class="p">:</span> <span class="n">applied_constraints</span><span class="p">,</span>
            <span class="s2">&quot;scenario_metadata&quot;</span><span class="p">:</span> <span class="n">selected_metadata</span><span class="p">,</span>  <span class="c1"># 使用包含选择属性的metadata</span>
            <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                <span class="s2">&quot;max_length&quot;</span><span class="p">:</span> <span class="mi">256</span>
            <span class="p">},</span>
            <span class="s2">&quot;generation_settings&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;prompt_constraint&quot;</span><span class="p">:</span> <span class="n">prompt_constraint</span><span class="p">,</span>
                <span class="s2">&quot;diversity_level&quot;</span><span class="p">:</span> <span class="n">diversity_level</span><span class="p">,</span>
                <span class="s2">&quot;llm_diversification&quot;</span><span class="p">:</span> <span class="n">diversity_level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">}</span>
        <span class="p">}</span>
        

        <span class="k">if</span> <span class="n">applied_constraints</span><span class="p">:</span>
            <span class="n">scenario_metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scenario_metadata&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">applied_constraints</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;attribute&quot;</span> <span class="ow">in</span> <span class="n">constraint</span> <span class="ow">and</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
                    <span class="n">scenario_metadata</span><span class="p">[</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;attribute&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;scenario_metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scenario_metadata</span>
        
        <span class="c1"># Create record with enhanced metadata</span>
        <span class="k">return</span> <span class="n">AgentActionRecord</span><span class="p">(</span>
            <span class="n">scenario_name</span><span class="o">=</span><span class="n">diverse_scenario</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">user_request</span><span class="o">=</span><span class="n">user_request</span><span class="p">,</span>
            <span class="n">agent_action</span><span class="o">=</span><span class="n">agent_action</span><span class="p">,</span>
            <span class="n">agent_response</span><span class="o">=</span><span class="n">agent_response</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span>
        <span class="p">)</span></div>

        
<div class="viewcode-block" id="LocalHarmlessDataGenerator.generate_batch_concurrent">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.LocalHarmlessDataGenerator.generate_batch_concurrent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_batch_concurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario</span><span class="p">:</span> <span class="n">Scenario</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">diversity_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentActionRecord</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a batch of agent action records concurrently for a given scenario.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            scenario: Scenario to generate records for</span>
<span class="sd">            n: Number of records to generate</span>
<span class="sd">            max_workers: Maximum number of concurrent workers</span>
<span class="sd">            diversity_range: Range of diversity levels to use (min, max)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            List of generated records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_diversity</span><span class="p">,</span> <span class="n">max_diversity</span> <span class="o">=</span> <span class="n">diversity_range</span>
        
        <span class="c1"># Create tasks with varying diversity levels</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1"># Generate a random diversity level within the specified range</span>
            <span class="n">diversity_level</span> <span class="o">=</span> <span class="n">min_diversity</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_diversity</span> <span class="o">-</span> <span class="n">min_diversity</span><span class="p">)</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">scenario</span><span class="p">,</span> <span class="n">diversity_level</span><span class="p">))</span>
        
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">max_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_record</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Generating records for </span><span class="si">{</span><span class="n">scenario</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">record</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during concurrent generation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">records</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the LLM output into user_request, agent_action, agent_response.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_request</span> <span class="o">=</span> <span class="n">agent_response</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">agent_action</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">current_section</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">inside_code_block</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">code_block_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;```&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;/*&quot;</span><span class="p">,</span> <span class="s2">&quot;*/&quot;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="c1"># Check if we&#39;re entering or leaving a code block</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">code_block_markers</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;```&quot;</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&#39;&#39;&#39;&quot;</span><span class="p">:</span>
                <span class="n">inside_code_block</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">inside_code_block</span>
                <span class="k">continue</span>
                
            <span class="c1"># Skip processing lines inside code blocks for agent_action section</span>
            <span class="k">if</span> <span class="n">inside_code_block</span> <span class="ow">and</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s2">&quot;agent_action&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;user request:&quot;</span><span class="p">):</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="s2">&quot;user_request&quot;</span>
                <span class="n">user_request</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;agent action:&quot;</span><span class="p">):</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="s2">&quot;agent_action&quot;</span>
                <span class="c1"># First line might contain the first step</span>
                <span class="n">action_part</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">action_part</span><span class="p">:</span>
                    <span class="c1"># Remove numbering and add to list</span>
                    <span class="n">cleaned_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_step</span><span class="p">(</span><span class="n">action_part</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cleaned_step</span><span class="p">:</span>
                        <span class="n">agent_action</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned_step</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;agent response:&quot;</span><span class="p">):</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="s2">&quot;agent_response&quot;</span>
                <span class="n">agent_response</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s2">&quot;agent_action&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inside_code_block</span><span class="p">:</span>
                <span class="c1"># Additional action steps</span>
                <span class="n">cleaned_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_step</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cleaned_step</span><span class="p">:</span>
                    <span class="n">agent_action</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cleaned_step</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">current_section</span> <span class="o">==</span> <span class="s2">&quot;agent_response&quot;</span> <span class="ow">and</span> <span class="n">agent_response</span><span class="p">:</span>
                <span class="c1"># Multi-line response</span>
                <span class="n">agent_response</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">line</span>
                
        <span class="c1"># Filter out any empty entries from agent_action</span>
        <span class="n">agent_action</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">agent_action</span> <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                
        <span class="k">return</span> <span class="n">user_request</span><span class="p">,</span> <span class="n">agent_action</span><span class="p">,</span> <span class="n">agent_response</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean a step by removing numbering and extra whitespace.</span>
<span class="sd">        Filter out markdown code block markers and other non-action content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        <span class="c1"># Skip markdown code block markers and their language specifiers</span>
        <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">step</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;```&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        
        <span class="c1"># Skip other common non-action content</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Example:&quot;</span><span class="p">,</span> <span class="s2">&quot;Note:&quot;</span><span class="p">,</span> <span class="s2">&quot;Output:&quot;</span><span class="p">,</span> <span class="s2">&quot;Input:&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            
        <span class="c1"># Remove numbering patterns like &quot;1.&quot;, &quot;2)&quot;, &quot;- &quot;, etc.</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\s*(\d+[\.\)]\s*|-\s*|\*\s*)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cleaned</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></div>



<div class="viewcode-block" id="save_records_to_json">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.save_records_to_json">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_records_to_json</span><span class="p">(</span><span class="n">records</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AgentActionRecord</span><span class="p">],</span> <span class="n">settings</span><span class="p">:</span> <span class="s2">&quot;GenerationSettings&quot;</span><span class="p">,</span> <span class="n">scenario_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a list of AgentActionRecord to a JSON or JSONL file in the configured save directory.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        records: List of records to save</span>
<span class="sd">        settings: Generation settings containing output configuration</span>
<span class="sd">        scenario_name: Name of the scenario for filename generation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create save directory if it doesn&#39;t exist</span>
    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">save_dir</span><span class="p">)</span>
    <span class="n">save_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Get file format from settings or use default</span>
    <span class="n">file_format</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;file_format&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">)</span>
    
    <span class="c1"># Generate filename from template</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">record_file_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">scenario_name</span><span class="o">=</span><span class="n">scenario_name</span><span class="p">,</span>
        <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
        <span class="n">ext</span><span class="o">=</span><span class="n">file_format</span>
    <span class="p">)</span>
    
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">/</span> <span class="n">filename</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span><span class="si">}</span><span class="s2"> records to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">file_format</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> format&quot;</span><span class="p">)</span>
    
    <span class="n">records_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="c1"># 处理Pydantic v1或v2的不同序列化方法</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">):</span>
                <span class="n">rec_data</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>  <span class="c1"># Pydantic v2</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="s2">&quot;dict&quot;</span><span class="p">):</span>
                <span class="n">rec_data</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>  <span class="c1"># Pydantic v1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 手动转换为字典</span>
                <span class="n">rec_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;scenario_name&quot;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">scenario_name</span><span class="p">,</span>
                    <span class="s2">&quot;user_request&quot;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">user_request</span><span class="p">,</span>
                    <span class="s2">&quot;agent_action&quot;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">agent_action</span><span class="p">,</span>
                    <span class="s2">&quot;agent_response&quot;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">agent_response</span><span class="p">,</span>
                    <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">rec</span><span class="o">.</span><span class="n">metadata</span>
                <span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error serializing record: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="n">rec_data</span> <span class="ow">and</span> <span class="s2">&quot;constraints&quot;</span> <span class="ow">in</span> <span class="n">rec_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rec_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;constraints&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;scenario_metadata&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rec_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]:</span>
                <span class="n">rec_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;scenario_metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">rec_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;constraints&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s2">&quot;attribute&quot;</span> <span class="ow">in</span> <span class="n">constraint</span> <span class="ow">and</span> <span class="s2">&quot;value&quot;</span> <span class="ow">in</span> <span class="n">constraint</span><span class="p">:</span>
                    <span class="n">rec_data</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;scenario_metadata&quot;</span><span class="p">][</span><span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;attribute&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">constraint</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        
        <span class="n">records_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec_data</span><span class="p">)</span>
    
    <span class="c1"># Save based on configured format</span>
    <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
        <span class="c1"># Save as single JSON array</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">records_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Save as JSONL (one JSON object per line)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rec_data</span> <span class="ow">in</span> <span class="n">records_data</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">rec_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Records saved to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filepath</span></div>



<div class="viewcode-block" id="OutputConfig">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.OutputConfig">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OutputConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for output settings.&quot;&quot;&quot;</span>
    <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;save&quot;</span>
    <span class="n">record_file_template</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{scenario_name}</span><span class="s2">_</span><span class="si">{timestamp}</span><span class="s2">_</span><span class="si">{mode}</span><span class="s2">.</span><span class="si">{ext}</span><span class="s2">&quot;</span>
    <span class="n">file_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;^(json|jsonl)$&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Output file format: json or jsonl&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="LocalConfig">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.LocalConfig">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LocalConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for local HuggingFace model generation.&quot;&quot;&quot;</span>
    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;llama3.1-8b-instruct&quot;</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span></div>



<div class="viewcode-block" id="GenerationSettings">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.GenerationSettings">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GenerationSettings</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Top-level generation settings covering both modes.&quot;&quot;&quot;</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="s2">&quot;openai&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;^(openai|local)$&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Generation mode: openai or local&quot;</span><span class="p">)</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Default batch size for generation&quot;</span><span class="p">)</span>
    <span class="n">externalAPI_generation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Whether to use externalAPI internal inference API&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="p">:</span> <span class="n">OutputConfig</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">OutputConfig</span><span class="p">)</span>
    <span class="n">openai</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OpenAIConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">local</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LocalConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">externalAPI</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">externalAPIConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="GenerationSettings.validate_openai">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.GenerationSettings.validate_openai">[docs]</a>
    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;openai&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_openai</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure OpenAI config is present if mode is &#39;openai&#39;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;openai&quot;</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">OpenAIConfig</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span></div>


<div class="viewcode-block" id="GenerationSettings.validate_local">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.GenerationSettings.validate_local">[docs]</a>
    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_local</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure local config is present if mode is &#39;local&#39;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LocalConfig</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">v</span></div>

        
<div class="viewcode-block" id="GenerationSettings.validate_externalAPI">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.GenerationSettings.validate_externalAPI">[docs]</a>
    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;externalAPI&quot;</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_externalAPI</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure externalAPI config is present if externalAPI_generation is True.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;externalAPI_generation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">externalAPIConfig</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">v</span></div>
</div>



<div class="viewcode-block" id="load_generation_settings">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.load_generation_settings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_generation_settings</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenerationSettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load generation settings from YAML file.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        yaml_path: Path to YAML file</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        GenerationSettings object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">yaml_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">yaml_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration file not found: </span><span class="si">{</span><span class="n">yaml_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">yaml_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Extract generation section</span>
        <span class="n">gen_data</span> <span class="o">=</span> <span class="n">yaml_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;generation&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="c1"># 从inference模块导入配置类</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">AuraGen.inference</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIConfig</span><span class="p">,</span> <span class="n">externalAPIConfig</span>

        <span class="c1"># Resolve api_key from env if api_key_type is provided</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_api_key_from_env</span><span class="p">(</span><span class="n">api_key_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">AuraGen.api_key_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_api_key_manager</span>
            <span class="k">return</span> <span class="n">get_api_key_manager</span><span class="p">()</span><span class="o">.</span><span class="n">resolve_api_key</span><span class="p">(</span><span class="n">api_key_type</span><span class="p">)</span>

        <span class="n">openai_section</span> <span class="o">=</span> <span class="n">yaml_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openai&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="s1">&#39;openai&#39;</span> <span class="ow">in</span> <span class="n">yaml_data</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">openai_section</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;api_key&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">openai_section</span> <span class="ow">and</span> <span class="s1">&#39;api_key_type&#39;</span> <span class="ow">in</span> <span class="n">openai_section</span><span class="p">:</span>
            <span class="n">openai_section</span><span class="p">[</span><span class="s1">&#39;api_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resolve_api_key_from_env</span><span class="p">(</span><span class="n">openai_section</span><span class="p">[</span><span class="s1">&#39;api_key_type&#39;</span><span class="p">])</span>

        <span class="n">externalAPI_section</span> <span class="o">=</span> <span class="n">yaml_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;externalAPI&#39;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="s1">&#39;externalAPI&#39;</span> <span class="ow">in</span> <span class="n">yaml_data</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">externalAPI_section</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;api_key&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">externalAPI_section</span> <span class="ow">and</span> <span class="s1">&#39;api_key_type&#39;</span> <span class="ow">in</span> <span class="n">externalAPI_section</span><span class="p">:</span>
            <span class="n">externalAPI_section</span><span class="p">[</span><span class="s1">&#39;api_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_resolve_api_key_from_env</span><span class="p">(</span><span class="n">externalAPI_section</span><span class="p">[</span><span class="s1">&#39;api_key_type&#39;</span><span class="p">])</span>

        <span class="c1"># Construct settings object</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">GenerationSettings</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">gen_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;openai&#39;</span><span class="p">),</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">gen_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
            <span class="n">externalAPI_generation</span><span class="o">=</span><span class="n">gen_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;externalAPI_generation&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">output</span><span class="o">=</span><span class="n">OutputConfig</span><span class="p">(</span><span class="o">**</span><span class="n">yaml_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="p">{})),</span>
            <span class="n">openai</span><span class="o">=</span><span class="n">OpenAIConfig</span><span class="p">(</span><span class="o">**</span><span class="n">openai_section</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">openai_section</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">local</span><span class="o">=</span><span class="n">LocalConfig</span><span class="p">(</span><span class="o">**</span><span class="n">yaml_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="p">{}))</span> <span class="k">if</span> <span class="s1">&#39;local&#39;</span> <span class="ow">in</span> <span class="n">yaml_data</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">externalAPI</span><span class="o">=</span><span class="n">externalAPIConfig</span><span class="p">(</span><span class="o">**</span><span class="n">externalAPI_section</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">externalAPI_section</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">settings</span>
        
    <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid YAML format in </span><span class="si">{</span><span class="n">yaml_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load generation settings from </span><span class="si">{</span><span class="n">yaml_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_openai_config">
<a class="viewcode-back" href="../../api/generation.html#AuraGen.generation.load_openai_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_openai_config</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OpenAIConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load OpenAI API configuration from a YAML file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">AuraGen.inference</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIConfig</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading OpenAI API configuration from </span><span class="si">{</span><span class="n">yaml_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">OpenAIConfig</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span> </div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, AuraGen Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>